name: WebGL Build
# コードがmainにpushされた時とpullreqが飛んできた時に自動で実行し手動でも実行できるようにする
  
on:
  push:
    branches: 
        - main
    paths:
        - Streamerio_unity/**
  pull_request: 
    branches:
        - main
    paths:
        - Streamerio_unity/**
  workflow_dispatch: {}

# 連続して実行されたときに一つ前の実行中のジョブが停止されるようにする
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
  
jobs:
  webgl-Build:
    name: Run the unity build steps
    runs-on: ubuntu-latest
    steps:
      # Actionsがリポジトリにアクセスできるようにする
      - name: Checkout
        uses: actions/checkout@v3
      
      # 環境変数を再配置する
      - name: Restore Env Script
        env:
          ENV_DATA: ${{ secrets.UNITY_ENV }}
          TARGET_DIR: "Streamerio_unity/Assets/Env"
          TARGET_FILE: "Streamerio_unity/Assets/Env/Parameter.cs"
        run: |
          # 1. 親ディレクトリを含めてフォルダを作成 (存在していてもエラーにならない)
          mkdir -p "$TARGET_DIR"

          # 2. ファイルを配置
          echo "$ENV_DATA" > "$TARGET_FILE"

          # (確認用) ファイルが配置されたかログに出す（中身は見えないので安全）
          ls -R "$TARGET_DIR"
      
      # LibraryをCacheしてBuildを高速化する
      - name: Cache Library
        uses: actions/cache@v3
        with:
          path: Streamerio_unity/Library
          key: Library-${{ hashFiles('Streamerio_unity/Assets/**', 'Streamerio_unity/Packages/**','Streamerio_unity/ProjectSettings/**') }}
          restore-keys: Library-
      # 1. Unityエディタのセットアップ (Buildalon)
      - name: Setup Unity
        uses: buildalon/unity-setup@v1
        with:
          build-targets: WebGL
          # version: '6000.0.57f1'

      # 2. ライセンス認証 (Buildalon: Email/Pass方式)
      # ※ 事前にGitHub Secretsに UNITY_USERNAME と UNITY_PASSWORD を設定してください
      - name: Activate Unity License
        uses: buildalon/activate-unity-license@v1
        with:
          license: 'Personal'
          username: ${{ secrets.UNITY_USERNAME }}
          password: ${{ secrets.UNITY_PASSWORD }}

      # 3. Buildalon用パッケージの追加 (必須)
      # GameCIと違い、ビルド機能をプロジェクトに追加するために必要です
      - name: Add Buildalon Package
        working-directory: Streamerio_unity
        run: |
          npm install -g openupm-cli
          openupm add com.virtualmaker.buildalon

      - name: Run the WebGL build
        uses: buildalon/unity-action@v1
        id: unity_build
        continue-on-error: true # Unity終了時のクラッシュ(Segfault)を無視して続行させる
        with:
          build-target: WebGL
          project-path: Streamerio_unity # プロジェクトフォルダ名を指定

      - name: Check Build Artifacts
        run: |
          # ビルド成果物があるか確認
          if [ -d "Streamerio_unity/Builds/WebGL" ] && [ "$(ls -A Streamerio_unity/Builds/WebGL)" ]; then
            echo "Build artifacts found. Proceeding."
            exit 0
          else
            echo "Build artifacts NOT found. Unity build likely failed."
            exit 1
          fi

      # 5. Build成果物をアップロードする
      # Buildalonのデフォルト出力先は 'Builds' フォルダになります
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: build
          path: Streamerio_unity/Builds/WebGL # パスが変更になる点に注意